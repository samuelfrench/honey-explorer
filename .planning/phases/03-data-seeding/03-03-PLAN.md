---
phase: 03-data-seeding
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - scripts/generate-images.js
  - scripts/package.json
  - backend/src/main/resources/seed-data/honeys.json
  - backend/src/main/resources/seed-data/local-sources.json
autonomous: false

user_setup:
  - service: replicate
    why: "AI image generation for honey product photography"
    env_vars:
      - name: REPLICATE_API_TOKEN
        source: "Replicate.com -> Account -> API Tokens -> Create Token"
    account_setup:
      - task: "Create Replicate account"
        location: "https://replicate.com/signin"
      - task: "Add payment method"
        location: "Replicate.com -> Account -> Billing"
  - service: cloudflare-r2
    why: "Permanent CDN-backed image storage"
    env_vars:
      - name: R2_ACCOUNT_ID
        source: "Cloudflare Dashboard -> R2 -> Account ID (shown on overview)"
      - name: R2_ACCESS_KEY
        source: "Cloudflare Dashboard -> R2 -> Manage R2 API Tokens -> Create API Token"
      - name: R2_SECRET_KEY
        source: "Same token creation page (shown once)"
      - name: R2_BUCKET_NAME
        source: "Name you choose when creating bucket"
      - name: R2_PUBLIC_URL
        source: "Cloudflare Dashboard -> R2 -> {bucket} -> Settings -> Public Access URL"
    account_setup:
      - task: "Create Cloudflare account (free)"
        location: "https://dash.cloudflare.com/sign-up"
    dashboard_config:
      - task: "Create R2 bucket named 'honey-explorer-images'"
        location: "Cloudflare Dashboard -> R2 -> Create Bucket"
      - task: "Enable public access on bucket"
        location: "R2 -> {bucket} -> Settings -> Public Access -> Allow Access"
      - task: "Set up custom domain (optional)"
        location: "R2 -> {bucket} -> Settings -> Custom Domains"

must_haves:
  truths:
    - "Each honey has a real CDN-hosted image (not placeholder URL)"
    - "Each local source has a real CDN-hosted image"
    - "Hero images exist for each honey type (17 FloralSource values)"
    - "Images are WebP format for optimal web delivery"
    - "All URLs are permanent (not expiring Replicate URLs)"
  artifacts:
    - path: "scripts/generate-images.js"
      provides: "Node.js script for Replicate + R2 workflow"
      contains: "replicate.run"
    - path: "scripts/package.json"
      provides: "Node.js dependencies"
      contains: "replicate"
    - path: "backend/src/main/resources/seed-data/honeys.json"
      provides: "Updated with real CDN URLs"
      contains: "images.honeyexplorer.com"
    - path: "backend/src/main/resources/seed-data/local-sources.json"
      provides: "Updated with real CDN URLs"
      contains: "images.honeyexplorer.com"
  key_links:
    - from: "generate-images.js"
      to: "Replicate API"
      via: "replicate.run"
      pattern: "replicate\\.run.*flux-schnell"
    - from: "generate-images.js"
      to: "Cloudflare R2"
      via: "@aws-sdk/client-s3"
      pattern: "PutObjectCommand"
    - from: "honeys.json imageUrl"
      to: "R2 bucket"
      via: "CDN URL"
      pattern: "https://.*\\.r2\\.dev|images\\.honeyexplorer\\.com"
---

<objective>
Generate AI product photography for all honeys and local sources, upload to Cloudflare R2, and update seed data with permanent CDN URLs.

Purpose: Each honey and local source needs a high-quality image for the visual-first design. Replicate's FLUX schnell model generates photorealistic product shots at $0.003/image. Images must be downloaded immediately (Replicate URLs expire in 1 hour) and uploaded to R2 for permanent CDN hosting.

Output: Node.js image generation script, all images hosted on R2, JSON seed files updated with real CDN URLs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-data-seeding/03-RESEARCH.md
@.planning/phases/03-data-seeding/03-01-SUMMARY.md
@.planning/phases/03-data-seeding/03-02-SUMMARY.md
@backend/src/main/resources/seed-data/honeys.json
@backend/src/main/resources/seed-data/local-sources.json
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <what>Set up Replicate and Cloudflare R2 accounts with API credentials</what>
  <why>Image generation requires Replicate API token, image hosting requires R2 credentials. These are external services requiring account creation.</why>
  <instructions>
1. **Replicate Setup** (for AI image generation):
   - Go to https://replicate.com/signin and create an account
   - Add a payment method at Account -> Billing (FLUX schnell costs ~$0.003/image)
   - Create an API token at Account -> API Tokens
   - Save the token - you'll need it as REPLICATE_API_TOKEN

2. **Cloudflare R2 Setup** (for permanent image storage):
   - Go to https://dash.cloudflare.com/sign-up and create a free account
   - Navigate to R2 in the sidebar
   - Create a bucket named "honey-explorer-images"
   - In bucket Settings, enable "Public Access" -> "Allow Access"
   - Note your Account ID from the R2 overview page
   - Go to "Manage R2 API Tokens" and create a token with read/write permissions
   - Save the Access Key ID and Secret Access Key (shown only once)
   - Note the public URL for your bucket (e.g., pub-xxx.r2.dev)

3. **Create environment file**:
   Create a file at `scripts/.env` with:
   ```
   REPLICATE_API_TOKEN=your_replicate_token
   R2_ACCOUNT_ID=your_cloudflare_account_id
   R2_ACCESS_KEY=your_r2_access_key
   R2_SECRET_KEY=your_r2_secret_key
   R2_BUCKET_NAME=honey-explorer-images
   R2_PUBLIC_URL=https://pub-xxx.r2.dev
   ```

4. **Estimated cost**: ~$2 for generating all images (200+ honeys + 50+ sources + 17 type heroes)
  </instructions>
  <resume-signal>Type "credentials ready" when .env file is created with all credentials</resume-signal>
</task>

<task type="auto">
  <name>Task 1: Create Node.js Image Generation Script</name>
  <files>
    scripts/package.json
    scripts/generate-images.js
  </files>
  <action>
Create scripts directory at project root if not exists.

Create scripts/package.json:
```json
{
  "name": "honey-explorer-image-gen",
  "type": "module",
  "scripts": {
    "generate": "node generate-images.js"
  },
  "dependencies": {
    "replicate": "^0.25.0",
    "@aws-sdk/client-s3": "^3.500.0",
    "dotenv": "^16.3.0"
  }
}
```

Create scripts/generate-images.js:
- Load environment variables with dotenv
- Initialize Replicate client
- Initialize S3Client for R2 (same config pattern as Java R2ClientConfig)
- Load honeys.json and local-sources.json from ../backend/src/main/resources/seed-data/

Implement prompt templates (from RESEARCH.md):
```javascript
const prompts = {
  honeyProduct: (name, floralSource, origin) =>
    `Professional product photography of a glass honey jar filled with golden ${floralSource.toLowerCase().replace('_', ' ')} honey from ${origin.replace('_', ' ')}, elegant label, natural wood honey dipper resting on side, soft diffused studio lighting, warm amber tones, pure white seamless background, 85mm lens, commercial quality, photorealistic, 8k resolution`,

  localSource: (name, sourceType) => {
    const descriptions = {
      BEEKEEPER: "rustic apiary with white beehive boxes in meadow setting",
      FARM: "pastoral honey farm with production building and bee gardens",
      FARMERS_MARKET: "vibrant farmers market booth with honey jars display",
      STORE: "artisanal honey shop storefront with warm lighting",
      APIARY: "professional apiary with multiple hive colonies",
      COOPERATIVE: "beekeeping cooperative facility with signage"
    };
    return `Professional photography of a ${descriptions[sourceType]}, warm natural sunlight, inviting rural atmosphere, commercial quality, 8k`;
  },

  heroType: (floralSource) =>
    `Editorial hero image of ${floralSource.toLowerCase().replace('_', ' ')} honey flowing from wooden dipper into glass jar, dramatic golden light, visible texture and viscosity, honeycomb in soft focus background, warm color palette, magazine quality, 8k`
};
```

Implement generateImage function:
- Call replicate.run("black-forest-labs/flux-schnell", {...})
- Use aspect_ratio "4:5" for products, "16:9" for heroes
- Output format: webp, quality: 85
- Returns image as buffer (latest Replicate SDK returns file objects)

Implement uploadToR2 function:
- Use PutObjectCommand with bucket, key, Body, ContentType
- Return public URL

Implement main workflow:
1. Generate hero images for each FloralSource (17 images)
   - Save to honeys/heroes/{floralSource}.webp
2. For each honey in honeys.json:
   - Generate product image
   - Save to honeys/{slug}.webp
   - Generate thumbnail (can reuse same image, different path)
   - Save to honeys/thumbnails/{slug}.webp
   - Update JSON entry with real URLs
3. For each local source in local-sources.json:
   - Generate source image
   - Save to sources/{slug}.webp
   - Save to sources/thumbnails/{slug}.webp
   - Update JSON entry with real URLs
4. Write updated JSON files back to disk

Add progress logging (e.g., "Generated 50/200 honeys...")
Add delay between requests (500ms) to avoid rate limits
Add error handling with retry logic (3 attempts per image)

IMPORTANT: Replicate output URLs expire in 1 hour. The script must download/upload to R2 immediately after generation - never store Replicate URLs in the JSON.
  </action>
  <verify>
Run: `cd /home/sam/claude-workspace/honey-explorer/scripts && npm install`
Verify dependencies install successfully.
  </verify>
  <done>Image generation script created with Replicate + R2 integration</done>
</task>

<task type="auto">
  <name>Task 2: Generate Images and Update Seed Data</name>
  <files>
    backend/src/main/resources/seed-data/honeys.json
    backend/src/main/resources/seed-data/local-sources.json
  </files>
  <action>
Run the image generation script:
```bash
cd /home/sam/claude-workspace/honey-explorer/scripts && npm run generate
```

This will:
1. Generate ~17 hero images for FloralSource types
2. Generate ~200+ honey product images
3. Generate ~50+ local source images
4. Generate thumbnails for all
5. Upload all to R2
6. Update the JSON files with real CDN URLs

Expected runtime: 30-60 minutes (depends on Replicate queue)
Expected cost: ~$2.00 (533 images at $0.003/image + buffer)

After completion, verify:
- All imageUrl and thumbnailUrl fields in honeys.json point to R2 CDN
- All heroImageUrl and thumbnailUrl fields in local-sources.json point to R2 CDN
- No placeholder URLs remain
- URLs are accessible (spot check 3-5 URLs with curl)
  </action>
  <verify>
Run: `cd /home/sam/claude-workspace/honey-explorer/backend && cat src/main/resources/seed-data/honeys.json | python3 -c "import json,sys; d=json.load(sys.stdin); placeholders=[h for h in d if 'placeholder' in h.get('imageUrl','').lower()]; print(f'Placeholders remaining: {len(placeholders)}')" 2>/dev/null`
Verify output shows "Placeholders remaining: 0"

Run: `curl -I $(cat /home/sam/claude-workspace/honey-explorer/backend/src/main/resources/seed-data/honeys.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(d[0]['imageUrl'])" 2>/dev/null) 2>/dev/null | head -1`
Verify returns HTTP 200.
  </verify>
  <done>All seed data images generated, uploaded to R2, and JSON files updated with permanent CDN URLs</done>
</task>

<task type="auto">
  <name>Task 3: Configure Fly.io R2 Secrets for Production Seeding</name>
  <files>None (Fly.io secrets only)</files>
  <action>
Set Fly.io secrets for production R2 access (needed when DataSeeder runs in production):

```bash
cd /home/sam/claude-workspace/honey-explorer

# Read values from scripts/.env and set as Fly secrets
fly secrets set \
  R2_ACCOUNT_ID=$(grep R2_ACCOUNT_ID scripts/.env | cut -d= -f2) \
  R2_ACCESS_KEY=$(grep R2_ACCESS_KEY scripts/.env | cut -d= -f2) \
  R2_SECRET_KEY=$(grep R2_SECRET_KEY scripts/.env | cut -d= -f2) \
  R2_BUCKET_NAME=$(grep R2_BUCKET_NAME scripts/.env | cut -d= -f2) \
  R2_PUBLIC_URL=$(grep R2_PUBLIC_URL scripts/.env | cut -d= -f2)
```

Note: R2 secrets are for ImageStorageService in production (future use for user uploads, dynamic image updates). The seed data already has CDN URLs baked in, so seeding itself doesn't need R2 access.
  </action>
  <verify>
Run: `cd /home/sam/claude-workspace/honey-explorer && fly secrets list | grep R2`
Verify R2_ACCOUNT_ID, R2_ACCESS_KEY, R2_SECRET_KEY, R2_BUCKET_NAME, R2_PUBLIC_URL are all set.
  </verify>
  <done>Fly.io production environment configured with R2 credentials</done>
</task>

</tasks>

<verification>
1. `scripts/package.json` exists with replicate and @aws-sdk/client-s3 dependencies
2. `scripts/generate-images.js` implements the full workflow
3. All honeys.json imageUrl fields point to R2 CDN (no placeholders)
4. All local-sources.json heroImageUrl fields point to R2 CDN
5. Sample images are accessible via HTTP (curl returns 200)
6. Fly.io has R2 secrets configured
7. Total image count matches expected (~533 images generated)
</verification>

<success_criteria>
- Node.js script generates images using FLUX schnell via Replicate
- Images immediately uploaded to Cloudflare R2 (not storing Replicate URLs)
- honeys.json updated with real CDN URLs for all 200+ entries
- local-sources.json updated with real CDN URLs for all 50+ entries
- Hero images generated for each FloralSource type
- All images accessible via public R2 URLs
- Fly.io production secrets configured for R2 access
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-seeding/03-03-SUMMARY.md`
</output>
