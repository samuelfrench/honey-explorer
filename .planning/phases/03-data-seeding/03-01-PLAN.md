---
phase: 03-data-seeding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/pom.xml
  - backend/src/main/java/com/honeyexplorer/config/R2ClientConfig.java
  - backend/src/main/java/com/honeyexplorer/service/ImageStorageService.java
  - backend/src/main/resources/application.properties
  - backend/src/main/resources/application-prod.properties
autonomous: true

must_haves:
  truths:
    - "R2 client can connect to Cloudflare storage"
    - "Images can be uploaded and return CDN URLs"
    - "Production environment uses Fly.io secrets for credentials"
  artifacts:
    - path: "backend/src/main/java/com/honeyexplorer/config/R2ClientConfig.java"
      provides: "S3 client configured for Cloudflare R2"
      contains: "S3Client"
    - path: "backend/src/main/java/com/honeyexplorer/service/ImageStorageService.java"
      provides: "Upload method returning CDN URL"
      exports: ["uploadImage"]
    - path: "backend/pom.xml"
      provides: "AWS SDK v2 dependencies"
      contains: "software.amazon.awssdk"
  key_links:
    - from: "ImageStorageService"
      to: "R2ClientConfig"
      via: "S3Client injection"
      pattern: "S3Client.*r2Client"
---

<objective>
Set up Cloudflare R2 integration for permanent image storage with CDN delivery.

Purpose: Honey and local source images need permanent CDN-backed storage. Replicate generates temporary URLs (1 hour expiration), so we need R2 to host images permanently. This infrastructure must be in place before image generation.

Output: R2 client configuration, ImageStorageService with upload capability, environment configuration for credentials.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-data-seeding/03-RESEARCH.md
@backend/pom.xml
@backend/src/main/resources/application.properties
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AWS SDK v2 Dependencies</name>
  <files>backend/pom.xml</files>
  <action>
Add AWS SDK v2 dependencies for S3-compatible R2 access:

1. Add properties section with AWS SDK version:
   ```xml
   <aws.sdk.version>2.31.50</aws.sdk.version>
   ```

2. Add dependencies:
   - software.amazon.awssdk:s3 (core S3 client)
   - software.amazon.awssdk:apache-client (HTTP transport)

Both dependencies should use ${aws.sdk.version} property.

Why AWS SDK: Cloudflare R2 is S3-compatible, official SDK handles auth, retries, multipart uploads.
  </action>
  <verify>
Run: `cd /home/sam/claude-workspace/honey-explorer/backend && ./mvnw dependency:resolve -q`
Verify no errors and S3 dependency resolves.
  </verify>
  <done>AWS SDK v2 for S3 available in project classpath</done>
</task>

<task type="auto">
  <name>Task 2: Create R2 Client Configuration and Image Storage Service</name>
  <files>
    backend/src/main/java/com/honeyexplorer/config/R2ClientConfig.java
    backend/src/main/java/com/honeyexplorer/service/ImageStorageService.java
    backend/src/main/resources/application.properties
    backend/src/main/resources/application-prod.properties
  </files>
  <action>
Create R2ClientConfig.java:
- @Configuration class
- @Bean for S3Client named r2Client
- @Value injections for: r2.account.id, r2.access.key, r2.secret.key
- Endpoint: https://{accountId}.r2.cloudflarestorage.com
- Region: Region.of("auto") (required but unused by R2)
- CRITICAL: pathStyleAccessEnabled(true) and chunkedEncodingEnabled(false) - R2 requires these
- Use StaticCredentialsProvider with AwsBasicCredentials
- Add @ConditionalOnProperty(name = "r2.enabled", havingValue = "true") to avoid errors when R2 not configured

Create ImageStorageService.java:
- @Service class with @ConditionalOnProperty(name = "r2.enabled", havingValue = "true")
- Inject S3Client r2Client
- @Value for r2.bucket.name and r2.public.url
- Method: String uploadImage(byte[] imageData, String key, String contentType)
  - Uses putObject with bucket, key, contentType
  - Returns publicUrl + "/" + key
- Method: String uploadImage(InputStream inputStream, String key, String contentType, long contentLength)
  - Overload for stream-based uploads

Update application.properties:
- Add r2.enabled=false (disabled by default for local dev)
- Add placeholder comments for r2.account.id, r2.access.key, r2.secret.key, r2.bucket.name, r2.public.url

Update/create application-prod.properties:
- r2.enabled=true
- r2.account.id=${R2_ACCOUNT_ID}
- r2.access.key=${R2_ACCESS_KEY}
- r2.secret.key=${R2_SECRET_KEY}
- r2.bucket.name=${R2_BUCKET_NAME}
- r2.public.url=${R2_PUBLIC_URL}
  </action>
  <verify>
Run: `cd /home/sam/claude-workspace/honey-explorer/backend && ./mvnw compile -q`
Verify compilation succeeds with no errors.
  </verify>
  <done>R2 client and ImageStorageService created, configured for production use via environment variables</done>
</task>

<task type="auto">
  <name>Task 3: Add Integration Test for R2 Service (Mocked)</name>
  <files>backend/src/test/java/com/honeyexplorer/service/ImageStorageServiceTest.java</files>
  <action>
Create a unit test that verifies ImageStorageService behavior with mocked S3Client:

1. Use @ExtendWith(MockitoExtension.class)
2. @Mock S3Client r2Client
3. @InjectMocks ImageStorageService (with ReflectionTestUtils to set bucket and publicUrl)
4. Test uploadImage returns correct URL format: "{publicUrl}/{key}"
5. Verify putObject called with correct parameters

This test validates the service logic without requiring actual R2 credentials.
  </action>
  <verify>
Run: `cd /home/sam/claude-workspace/honey-explorer/backend && ./mvnw test -Dtest=ImageStorageServiceTest -q`
Verify test passes.
  </verify>
  <done>ImageStorageService has unit test coverage proving URL generation logic</done>
</task>

</tasks>

<verification>
1. `./mvnw compile` succeeds
2. `./mvnw test` passes (including new ImageStorageService test)
3. R2ClientConfig creates S3Client bean when r2.enabled=true
4. ImageStorageService.uploadImage returns formatted CDN URL
5. Application starts without errors when r2.enabled=false (default for dev)
</verification>

<success_criteria>
- AWS SDK v2 dependencies added to pom.xml
- R2ClientConfig creates properly configured S3Client for Cloudflare R2
- ImageStorageService can upload images and return CDN URLs
- Configuration uses environment variables for production secrets
- Local development works without R2 (conditional beans)
- Unit test validates upload URL generation
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-seeding/03-01-SUMMARY.md`
</output>
