# Plan 06-01: Local Search API and Leaflet Map

## Goal
Build a local source discovery system with proximity search API and interactive Leaflet map with custom honey-themed markers.

## Success Criteria
- [ ] LocalSource search API with city/zip code proximity search
- [ ] Leaflet map displays all local sources with custom markers
- [ ] Marker clustering for zoom-out views
- [ ] Map filters by source type (beekeeper, farm, market, etc.)
- [ ] Click marker shows quick-glance info popup

## Tasks

### Backend API
1. Create `LocalSourceController` with endpoints:
   - `GET /api/local-sources` - List all with pagination
   - `GET /api/local-sources/search` - Search by city, state, zip, or coordinates
   - `GET /api/local-sources/nearby` - Proximity search within radius
   - `GET /api/local-sources/{id}` - Single source details

2. Create `LocalSourceService` with:
   - Specification pattern for dynamic filtering
   - Haversine distance calculation for proximity search
   - Result ordering by distance from search point

3. Create DTOs:
   - `LocalSourceDto` with all display fields
   - `LocalSourceSearchRequest` with filter params
   - `NearbySearchRequest` with lat/lng/radius

### Frontend Map
1. Install Leaflet and React-Leaflet:
   - `leaflet` + `react-leaflet` packages
   - Type definitions for TypeScript

2. Create `LocalSourcesPage`:
   - Split view: map (70%) + list sidebar (30%)
   - URL state for filters and map bounds
   - Mobile: toggle between map and list

3. Create map components:
   - `LocalSourceMap` - Leaflet container with tile layer
   - `SourceMarker` - Custom honey-themed markers
   - `MarkerCluster` - Clustered markers for zoomed-out view
   - `SourcePopup` - Quick-glance info card on marker click

4. Create source type icons:
   - Custom SVG icons for each SourceType
   - Honey jar for stores
   - Bee for beekeepers
   - Barn for farms
   - Market stall for farmers markets

5. Implement search:
   - City/zip search input with autocomplete (optional)
   - "Near me" button using geolocation API
   - Search triggers map pan and marker filter

## Implementation Notes
- Use OpenStreetMap tile layer (free, no API key)
- Haversine formula for distance: `d = 2r × arcsin(√(sin²((φ₂-φ₁)/2) + cos(φ₁)cos(φ₂)sin²((λ₂-λ₁)/2)))`
- Default radius: 50 miles for nearby search
- Map bounds: Fit to US initially, then to search results

## Dependencies
- Phase 2: LocalSource entity and repository ✓
- Phase 3: 52 local sources seeded ✓
- Phase 4: Design system components ✓

## Files to Create/Modify
- `backend/src/main/java/com/honeyexplorer/controller/LocalSourceController.java`
- `backend/src/main/java/com/honeyexplorer/service/LocalSourceService.java`
- `backend/src/main/java/com/honeyexplorer/dto/LocalSourceDto.java`
- `backend/src/main/java/com/honeyexplorer/dto/NearbySearchRequest.java`
- `backend/src/main/java/com/honeyexplorer/specification/LocalSourceSpecification.java`
- `frontend/src/pages/LocalSourcesPage.tsx`
- `frontend/src/components/local/*.tsx` (map components)
- `frontend/src/services/api.ts` (add localSourceApi)
